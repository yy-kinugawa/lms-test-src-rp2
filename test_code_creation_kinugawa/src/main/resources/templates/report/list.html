<!--Task.50 -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
	th:replace="~{/common/layout :: layout(~{::title},~{::body/content()})}">
<head>
<meta charset="UTF-8">
<title>レポート一覧 | LMS</title>
</head>
<body>

	<h2>レポート一覧</h2>
	<div class="well bs-component">

		<form th:method="post" th:action="@{/report/list}" class="form-horizontal" th:object="${dailyReportSearchForm}">
			<fieldset>
				<legend>検索</legend>

				<div class="form-group">
					<label for="dateFrom" class="col-lg-2 control-label">日付(From)</label>
					<div class="col-lg-10">
						<input type="text" id="dateFrom" name="dateFrom" th:value="*{dateFrom}" th:errorclass="errorInput"
							class="form-control datepicker" placeholder="例）2010-01-01" autocomplete="off" />
						<span th:errors="*{dateFrom}" class="help-inline error"></span>
					</div>
				</div>

				<div class="form-group">
					<label for="dateTo" class="col-lg-2 control-label">日付(To)</label>
					<div class="col-lg-10">
						<input type="text" id="dateTo" name="dateTo" th:value="*{dateTo}" th:errorclass="errorInput"
							class="form-control datepicker" placeholder="例）2010-01-01" autocomplete="off" />
						<span th:errors="*{dateTo}" class="help-inline error"></span>
					</div>
				</div>

				<div class="form-group">
					<label for="courseName" class="col-lg-2 control-label">コース名</label>
					<div class="col-lg-10">
						<input type="text" id="courseName" name="courseName" th:value="*{courseName}" class="form-control" list="courselist" />
						<datalist id="courselist">
							<option th:each="courseDto : *{courseDtoList}" th:value="${courseDto.courseName}"></option>
						</datalist>
					</div>
				</div>

				<div class="form-group">
					<label for="placeId" class="col-lg-2 control-label">会場名</label>
					<div th:if="${session.loginUserDto.role == '0002'}" class="col-lg-10">
						<input type="hidden"  id="placeId" name="placeId" th:value="*{placeId}" />
						<th:block th:if="*{#strings.isEmpty(placeNote)}">
							<input type="text" name="" th:value="*{placeName}" readonly="readonly" id="" class="form-control" />
						</th:block>
						<th:block th:if="*{not #strings.isEmpty(placeNote)}">
							<input type="text" name="" th:value="|*{placeName}(*{placeNote})|" readonly="readonly" id="" class="form-control" />
						</th:block>
					</div>
					<!-- Task.80 -->
					<div th:if="${session.loginUserDto.role == '0004'}" class="col-lg-10">
						<select name="placeId" class="form-control" id="placeId">
							<option value=""></option>
							<option th:each="placeDto : *{placeDtoList}" th:value="${placeDto.placeId}" 
								th:selected="${placeDto.placeId} == *{placeId}">[[${placeDto.placeName}]]
								<th:block th:if="${not #strings.isEmpty(placeDto.placeNote)}">([[${placeDto.placeNote}]])</th:block>
							</option>
						</select>
					</div>
				</div>

				<div class="form-group">
					<label for="companyName" class="col-lg-2 control-label">企業名</label>
					<div class="col-lg-10">
						<input type="text" id="companyName" name="companyName" th:value="*{companyName}" class="form-control" list="companylist" />
						<datalist id="companylist">
							<option th:each="companyDto : *{companyDtoList}" th:value="${companyDto.companyName}"></option>
						</datalist>
					</div>
				</div>

				<!-- Task.80 -->
				<div class="form-group">
					<div class="col-lg-2"></div>
					<div class="col-lg-10">
						<input type="checkbox" name="pastFlg" id="pastFlg" value="1" class="icon-checkbox" th:checked="*{pastFlg == 1}" />
						<label for="pastFlg" class="text-info"> 
							<span class='glyphicon glyphicon-unchecked unchecked'></span> 
							<span class='glyphicon glyphicon-check checked'></span>
						</label>
						<label for="pastFlg" class="control-label">コース終了後 [[*{pastTimeLabel}]] を経過した受講生 </label>
						<label class="text-danger"> ※コース終了後 [[*{pastTimeLabel}]] を経過した受講生を含めて検索します </label>
					</div>
				</div>

				<div class="form-group">
					<div class="col-lg-10 col-lg-offset-2">
						<input type="submit" name="search" value="検索" class="btn btn-primary" />
					</div>
				</div>

			</fieldset>
		</form>

	</div>

	<div class="form-group">
		<form th:action="@{/report/downloadList}" method="post">
			<div class="dailyList"></div>
			<input type="submit" value="チェックしたレポートをダウンロード" id="downloadCommit" class="hidden" />
		</form>
		<input type="submit" value="チェックしたレポートをダウンロード" id="download" class="btn btn-default" />
		<strong class="text-danger"> ※1度に50件までダウンロードできます。</strong>
		<div>
			<span class="help-inline error" id="downloadCheck"></span>
		</div>
	</div>

	<div id="daily-table_wrapper" class="dataTables_wrapper form-inline dt-bootstrap no-footer">
		<div class="row">
			<div class="col-sm-6">
				<div class="dataTables_length" id="daily-table_length"></div>
			</div>
		</div>
	</div>

	<div class="row">
		<div class="col-sm-12">
			<table class="table table-hover sortandsearchableandeckboxtable dataTable no-footer" id="daily-table" role="grid" aria-describedby="daily-table_info">
				<thead>
					<tr role="row">
						<th class="sorting_disabled" rowspan="1" colspan="1" aria-label="">
							<input id="checkbox-all" class="icon-checkbox" type="checkbox" />
							<label for="checkbox-all" class="text-info"> 
								<span class="glyphicon glyphicon-unchecked unchecked"></span> 
								<span class="glyphicon glyphicon-check checked"></span>
							</label>
						</th>
						<th class="sorting_asc" tabindex="0" aria-controls="daily-table" rowspan="1" colspan="1" aria-sort="ascending" 
							aria-label="ユーザー名: activate to sort column descending">ユーザー名</th>
						<th class="sorting" tabindex="0" aria-controls="daily-table" rowspan="1" colspan="1" 
							aria-label="提出日: activate to sort column ascending">提出日</th>
						<th class="sorting" tabindex="0" aria-controls="daily-table" rowspan="1" colspan="1" 
							aria-label="コース名: activate to sort column ascending">コース名</th>
						<th class="sorting" tabindex="0" aria-controls="daily-table" rowspan="1" colspan="1" 
							aria-label="企業名: activate to sort column ascending">企業名</th>
						<th class="sorting" tabindex="0" aria-controls="daily-table" rowspan="1" colspan="1" 
							aria-label="会場: activate to sort column ascending">会場</th>
						<th class="sorting" tabindex="0" aria-controls="daily-table" rowspan="1" colspan="1" 
							aria-label="レポート確認: activate to sort column ascending">レポート確認</th>
						<th class="sorting" tabindex="0" aria-controls="daily-table" rowspan="1" colspan="1" 
							aria-label="レポート修正: activate to sort column ascending">レポート修正</th>
					</tr>
				</thead>
				<tbody>
					<tr th:each="userDailyReportDto, stat : ${userDailyReportDtoList}" role="row" class="odd">
						<td>
							<th:block th:if="${not #strings.isEmpty(userDailyReportDto.dailyReportSubmitId)}">
								<input name="check" th:id="|checkbox[${stat.index}]|" class="icon-checkbox" type="checkbox" />
									<label th:for="|checkbox[${stat.index}]|" class="text-info"> 
										<span class="glyphicon glyphicon-unchecked unchecked"></span>
										<span class="glyphicon glyphicon-check checked"></span>
									</label>
								<input type="hidden" name="dailyReportId" th:value="${userDailyReportDto.dailyReportId}" />
								<input type="hidden" name="dailyReportSubmitId" th:value="${userDailyReportDto.dailyReportSubmitId}" />
							</th:block>
							<th:block th:if="${#strings.isEmpty(userDailyReportDto.dailyReportSubmitId)}">
								<span class="glyphicon glyphicon-minus" aria-hidden="true"></span>
								<span style="display: none;">1</span>
							</th:block>
						</td>
						<td class="sorting_1">[[${userDailyReportDto.userName}]]</td>
						<td>[[${#dates.format(userDailyReportDto.sectionDate, 'yyyy/MM/dd')}]]</td>
						<td>[[${userDailyReportDto.courseName}]]</td>
						<td>[[${userDailyReportDto.companyName}]]</td>
						<td>[[${userDailyReportDto.placeName}]]
							<small th:if="${not #strings.isEmpty(userDailyReportDto.placeNote)}">([[${userDailyReportDto.placeNote}]])</small>
						</td>
						<td>
							<th:block th:if="${#strings.isEmpty(userDailyReportDto.submitDate)}">未提出</th:block>
							<th:block th:if="${not #strings.isEmpty(userDailyReportDto.submitDate)}">
								<form th:action="@{/report/detail}" method="post">
									<input type="hidden" name="dailyReportSubmitId" th:value="${userDailyReportDto.dailyReportSubmitId}" />
									<button type="submit" class="btn btn-default">
										[[${userDailyReportDto.reportName}]]
										<span th:if="${userDailyReportDto.fbCount > 0}" class="badge">[[${userDailyReportDto.fbCount}]]</span>
									</button>
								</form>
							</th:block>
						</td>
						<td>
							<th:block th:if="${#strings.isEmpty(userDailyReportDto.submitDate)}">未提出</th:block>
							<th:block th:if="${not #strings.isEmpty(userDailyReportDto.submitDate)}">
								<form th:action="@{/report/regist}" method="post">
									<input type="hidden" name="dailyReportSubmitId" th:value="${userDailyReportDto.dailyReportSubmitId}" />
									<button type="submit" class="btn btn-default">修正する</button>
								</form>
							</th:block>
						</td>
					</tr>
				</tbody>
			</table>
		</div>
	</div>

	<script>
		$(function() {
			$("#checkbox-all").click(function() {
				allCheck("#daily-table", this);
			});
		});

		$(function() {
			$('#download').click(function() {
				$('.dailyList').children().remove();
				const chkRec = $('input[name=check]:checked').parents('tr');
				let html = '';
				$("#downloadCheck").text();
				if (chkRec.length == 0) {
					$("#downloadCheck").text('* ダウンロードするレポートにチェックをしてください。');
					return;
				} else if (chkRec.length > 50) {
					$("#downloadCheck").text('* チェックの数が多すぎます。1度にチェックは50以下にしてください。');
					return;
				} else {
					for (i = chkRec.length - 1; i >= 0; i--) {
						let dailyReportId = $(chkRec[i]).children('td').children(':hidden[name=dailyReportId]').val();
						let dailyReportSubmitId = $(chkRec[i]).children('td').children(':hidden[name=dailyReportSubmitId]').val();
						html += '<input type="hidden" name="dailyReportIdList[' + i + ']" value="' + dailyReportId + '">';
						html += '<input type="hidden" name="dailyReportSubmitIdList[' + i + ']" value="' + dailyReportSubmitId + '">';
					}
				}
				$('.dailyList').append(html);
				$('#downloadCommit').click();
			});
		});
	</script>

</body>
</html>