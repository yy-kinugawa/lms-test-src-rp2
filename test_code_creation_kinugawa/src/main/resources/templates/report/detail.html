<!-- Task.22 -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
	th:replace="~{/common/layout :: layout(~{::title},~{::body/content()})}">
<head>
<meta charset="UTF-8">
<title>レポート詳細 | LMS</title>
</head>
<body>

	<th:block th:object="${dailyReportDto}">

		<h2>[[*{reportName}]] <small>[[*{#dates.format(date, 'yyyy年M月d日')}]]</small></h2>
	
		<table class="table table-hover">
			<tr>
				<th class="wq">氏名</th>
				<td>[[*{userName}]]</td>
			</tr>
		</table>
	
		<div th:if="*{intelligibilityFlg == 1}">
			<h3>学習理解度</h3>
			<table class="table table-hover">
				<tr>
					<th class="wq">学習項目</th>
					<th>理解度（[[*{intelligibilityFieldNum}]]段階評価）</th>
				</tr>
				<tr th:each="intelligibilityDto : *{intelligibilityDtoList}">
					<td>
						<p th:text="${intelligibilityDto.fieldName}"></p>
					</td>
					<td>
						<p th:text="${intelligibilityDto.fieldValue}"></p>
					</td>
				</tr>
			</table>
		</div>
	
		<div th:if="*{dailyReportDetailDtoList != null}">
			<h3>報告レポート</h3>
			<table class="table table-hover">
				<tr th:each="dailyReportDetailDto : *{dailyReportDetailDtoList}">
					<th class="wq">[[${dailyReportDetailDto.fieldName}]]</th>
					<td>
						<th:block th:each="line: ${dailyReportDetailDto.content.split('\r\n|\r|\n', -1)}">
							<th:block th:text="${line}" />
							<br />
					</td>
				</tr>
			</table>
		</div>
	
		<!-- フィードバック -->
		<div class="mb30">
			<div th:if="*{dailyReportFbDtoList != null}">
				<div th:each="dailyReportFbDto, stat : *{dailyReportFbDtoList}">
					<div class="popover show mb10" style="position: relative; max-width: 100%;"
						th:classappend="${session.loginUserDto.lmsUserId == dailyReportFbDto.lmsUserId} ? right : left" >
						<h3 class="popover-title" th:text="${dailyReportFbDto.userName}"></h3>
						<div class="arrow"></div>
						<div class="popover-content">
							<p>[[${dailyReportFbDto.content}]]</p>
							<div class="tar">
								<form th:action="@{/report/feedback/delete}" method="post"
									th:if="${session.loginUserDto.lmsUserId == dailyReportFbDto.lmsUserId}" th:id="'deleteForm'+${stat.index}+''">
									<input type="hidden" th:name="dailyReportFbId" th:value="${dailyReportFbDto.dailyReportFbId}">
									<input type="hidden" th:name="dailyReportSubmitId" th:value="*{dailyReportSubmitId}" />
									<small th:if="${dailyReportFbDto.firstCreateDate != dailyReportFbDto.date}">[編集済]</small>
									<a th:attr="href='javascript:$(\'#div-modal-update' + ${stat.index} + '\').modal(\'show\')'">編集</a>
									<a onclick="return delcheck()" th:attr="href='javascript:$(\'#deleteForm' + ${stat.index} + '\').submit()'">削除</a>
									<span>[[${#dates.format(dailyReportFbDto.date, "yyyy/M/d HH:mm")}]]</span>
								</form>
								<th:block th:if="!${session.loginUserDto.lmsUserId == dailyReportFbDto.lmsUserId}">
									<span>[[${#dates.format(dailyReportFbDto.date, "yyyy/M/d HH:mm")}]]</span>
								</th:block>
							</div>
						</div>
					</div>

					<!-- Task.23 ②フィードバックコメントの修正 -->
					<div th:if="${session.loginUserDto.lmsUserId == dailyReportFbDto.lmsUserId}" class="modal fade" th:id="div-modal-update + ${stat.index}">
						<div class="modal-dialog modal-dialog-center">
							<div class="modal-content">
								<div class="modal-header">
									<button type="button" class="close" data-dismiss="modal" onclick="contentClear();">
										<span aria-hidden="true">&times;</span>
									</button>
									<h2 class="modal-title" id="modal-label">フィードバックコメント</h2>
								</div>
								<form th:action="@{/report/feedback/update}" method="post" class="form-horizontal" onsubmit="return submitcheck()">
									<input type="hidden" th:name="dailyReportFbId" th:value="${dailyReportFbDto.dailyReportFbId}" />
									<input type="hidden" th:name="dailyReportSubmitId" th:value="*{dailyReportSubmitId}" />
									<div class="modal-body">
										<div class="well bs-component">
											<fieldset>
												<legend>フィードバックコメントを入力してください。</legend>
												<div class="form-group">
													<div class="col-lg-10">
														<textarea th:name="content" class="form-control" th:id="content_update + ${stat.index}">[[${dailyReportFbDto.content}]]</textarea>
														<span class="help-inline error" th:id="content_update + ${stat.index} + _error"></span>
													</div>
												</div>
											</fieldset>
										</div>
									</div>
					                <div class="modal-footer">
					                  <input type="button" class="btn btn-primary" value="キャンセル" onclick="$('.modal').modal('hide');" />
					                  <input type="submit" class="btn btn-primary" value="提出する" th:onclick="|return contentCheck('content_update${stat.index}');|" />
					                </div>
								</form>
							</div>
						</div>
					</div>

				</div>
			</div>
		</div>
	
		<!-- Task.23 ③戻るボタンの追加 -->		
		<button type="button" class="btn btn-primary" onclick="history.back();">戻る</button>
		<!-- Task.23 ①フィードバックコメント登録のモーダル化 -->
		<button type="button" class="btn btn-primary" onclick="$('#div-modal-create').modal('show')">フィードバックコメントを登録する</button>
		
		<!-- Task.23 ①フィードバックコメント登録のモーダル化 -->
		<div class="modal fade" th:id="div-modal-create">
			<div class="modal-dialog modal-dialog-center">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" onclick="contentClear('content_create');">
							<span aria-hidden="true">&times;</span>
						</button>
						<h2 class="modal-title" id="modal-label">フィードバックコメント</h2>
					</div>
					<form th:action="@{/report/feedback/regist}" method="post" class="form-horizontal" onsubmit="return submitcheck()">
						<input type="hidden" th:name="dailyReportSubmitId" th:value="*{dailyReportSubmitId}" />
						<div class="modal-body">
							<div class="well bs-component">
								<fieldset>
									<legend>フィードバックコメントを入力してください。</legend>
									<div class="form-group">
										<div class="col-lg-10">
											<textarea th:name="content" class="form-control" id="content_create"></textarea>
											<span class="help-inline error" id="content_create_error"></span>
										</div>
									</div>
								</fieldset>
							</div>
						</div>
		                <div class="modal-footer">
		                  <input type="button" class="btn btn-primary" value="キャンセル" onclick="$('.modal').modal('hide');" />
		                  <input type="submit" class="btn btn-primary" value="提出する" onclick="return contentCheck('content_create');" />
		                </div>
					</form>
				</div>
			</div>
		</div>

	</th:block>

	<script>
		function contentCheck(idName) {
			// 必須と1000文字チェック
			const content = document.getElementById(idName);
			if (content.value == null || content.value.trim().length == 0) {
				document.getElementById(idName).classList.add('errorInput');
				document.getElementById(idName + '_error').innerHTML = '* 内容は必須です。';
				return false;
			} else if (content.value.length > 1000) {
				document.getElementById(idName).classList.add('errorInput');
				document.getElementById(idName + '_error').innerHTML = '* 内容の長さが最大値(1000)を超えています。';
				return false;
			}
			return true;
		}
		function contentClear(idName) {
			document.getElementById(idName).value = '';
			document.getElementById(idName).classList.remove('errorInput');
			document.getElementById(idName + '_error').innerHTML = '';
		}
	</script>

</body>
</html>