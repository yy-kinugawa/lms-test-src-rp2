<!-- Task.43 -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
	th:replace="~{/common/layout :: layout(~{::title},~{::body/content()})}">
<head>
<meta charset="UTF-8" />
<title>ユーザー一覧 | LMS</title>
</head>
<body>

	<!-- Task.79 -->
	<th:block th:if="${not #strings.isEmpty(message)}" id="message">
		<div class="alert alert-info alert-dismissible fade in" role="alert">
			<button type="button" class="close" data-dismiss="alert" aria-label="Close">
				<span aria-hidden="true">×</span>
			</button>
			<span th:text=${message}></span>
		</div>
	</th:block>

	<th:block th:object="${userListForm}">
	
		<h2>ユーザー一覧</h2>
		<div class="well bs-component">

			<!-- Task.79 -->
			<th:block th:if="${session.loginUserDto.role == '0004'}">
				<legend>ユーザー追加</legend>
				<div class="form-group">
					<a th:href="@{/user/registMenu}" class="btn btn-default">新規登録</a>
				</div>
			</th:block>

			<form th:action="@{/user/list}" method="post" class="form-horizontal">
				<fieldset>
					<legend>検索</legend>

					<div class="form-group">
						<label for="courseName" class="col-lg-2 control-label">コース名</label>
						<div class="col-lg-10">
							<input type="text" id="courseName" name="courseName" 
								th:value="*{courseName}" class="form-control" list="courselist" />
							<datalist id="courselist">
								<option th:each="courseDto : *{courseDtoList}" th:value="${courseDto.courseName}"></option>
							</datalist>
						</div>
					</div>

					<div class="form-group">
						<label for="placeId" class="col-lg-2 control-label">会場名</label>
						<div th:if="${session.loginUserDto.role == '0002'}" class="col-lg-10">
							<input type="hidden" th:value="*{placeId}" id="placeId" />
							<th:block th:if="*{#strings.isEmpty(placeNote)}">
								<input type="text" th:value="*{placeName}" readonly="readonly" id="" class="form-control" />
							</th:block>
							<th:block th:if="*{not #strings.isEmpty(placeNote)}">
								<input type="text" th:value="|*{placeName}(*{placeNote})|" readonly="readonly" class="form-control" />
							</th:block>
						</div>
						
						<!-- Task.79 -->
						<div th:if="${session.loginUserDto.role == '0004'}" class="col-lg-10">
							<select name="placeId" class="form-control" id="placeId">
								<option value=""></option>
								<option th:each="placeDto : *{placeDtoList}" th:value="${placeDto.placeId}" 
									th:selected="${placeDto.placeId} == *{placeId}">[[${placeDto.placeName}]]
									<th:block th:if="${not #strings.isEmpty(placeDto.placeNote)}">([[${placeDto.placeNote}]])</th:block>
								</option>
							</select>
						</div>
					</div>
	
					<div class="form-group">
						<label for="companyName" class="col-lg-2 control-label">企業名</label>
						<div class="col-lg-10">
							<input type="text" name="companyName" th:value="*{companyName}" id="companyName" 
								 th:errorclass="errorInput" class="form-control" list="companylist" />
							<datalist id="companylist">
								<option th:each="companyDto : *{companyDtoList}" th:value="${companyDto.companyName}"></option>
							</datalist>
							<span th:errors="*{companyName}" class="help-inline error"></span>
						</div>
					</div>
	
					<div class="form-group">
						<label for="userName" class="col-lg-2 control-label">ユーザー名</label>
						<div class="col-lg-10">
							<input type="text" name="userName" th:value="*{userName}" id="userName" class="form-control" />
						</div>
					</div>
	
					<!-- Task.79 -->
					<div th:if="${session.loginUserDto.role == '0004'}" class="form-group">
						<label for="role" class="col-lg-2 control-label">権限</label>
						<div class="col-lg-10">
							<select th:name="role" id="role" class="form-control">
								<option value=""></option>
								<option th:each="role : *{roleEnum}" th:value="${role.code}"
									th:selected="${role.code} == *{role}" class="form-control" >[[${role.value}]]</option>
							</select>
						</div>
					</div>
	
					<!-- Task.79 -->
					<div th:if="${session.loginUserDto.role == '0004'}" class="form-group">
						<div class="col-lg-2 "></div>
						<div class="col-lg-10">
							<input type="checkbox" name="leaveFlg" id="leaveFlg" value="1" 
								class="icon-checkbox" th:checked="*{leaveFlg == 1}">
							<label for="leaveFlg" class="text-info">
								<span class='glyphicon glyphicon-unchecked unchecked'></span>
								<span class='glyphicon glyphicon-check checked'></span>
							</label>
							<label for="leaveFlg" class="control-label">途中退校者</label>
							<label class="text-danger"> ※途中退校者のみを検索します</label>
						</div>
					</div>

					<!-- Task.79 -->
					<div th:if="${session.loginUserDto.role == '0004'}" class="form-group">
						<div class="col-lg-2 "></div>
						<div class="col-lg-10">
							<input type="checkbox" name="pastFlg" id="pastFlg" value="1" 
								class="icon-checkbox" th:checked="*{pastFlg == 1}">
							<label for="pastFlg" class="text-info">
								<span class='glyphicon glyphicon-unchecked unchecked'></span>
								<span class='glyphicon glyphicon-check checked'></span>
							</label>
							<label for="pastFlg" class="control-label">コース終了後 [[*{pastTimeLabel}]] を経過した受講生</label>
							<label class="text-danger"> ※コース終了後 [[*{pastTimeLabel}]] を経過した受講生を含めて検索します</label>
						</div>
					</div>
	
					<div class="form-group">
						<div class="col-lg-10 col-lg-offset-2">
							<input type="submit" name="search" value="検索" class="btn btn-primary" />
						</div>
					</div>
				</fieldset>
			</form>

			<!-- Task.79 -->
			<th:block th:if="${session.loginUserDto.role == '0004'}">
				<legend>一括操作</legend>
				<a href="#" class="btn btn-default" id="bulk-delete" data-toggle="modal" data-target="#bulk-del-modal">一括削除</a>
				<label class="text-danger"> ※一括削除は事務局のみ使用してください。</label>
			</th:block>

		</div>
	
		<div id="user-table_wrapper" class="dataTables_wrapper form-inline dt-bootstrap no-footer">
			<div class="row">
				<div class="col-sm-6">
					<div class="dataTables_length" id="user-table_length"></div>
				</div>
				<div class="col-sm-6"></div>
			</div>
			<div class="row">
				<div class="col-sm-12">
					<table class="table table-hover sortabletable dataTable no-footer" id="user-table" role="grid" aria-describedby="user-table_info">
						<thead>
							<tr role="row">
							
								<!-- Task.79 -->
								<th th:if="${session.loginUserDto.role == '0004'}">
										<input id="checkbox-all" class="icon-checkbox" type="checkbox" /> 
										<label for="checkbox-all" class="text-info">
											<span class='glyphicon glyphicon-unchecked unchecked'></span>
											<span class='glyphicon glyphicon-check checked'></span>
										</label>
								</th>

								<th class="sorting_asc" tabindex="0" aria-controls="user-table" rowspan="1" colspan="1" 
									aria-sort="ascending" aria-label="ID: activate to sort column descending">ID</th>
								<th class="sorting" tabindex="0" aria-controls="user-table" rowspan="1" colspan="1" 
									aria-label="ユーザー名: activate to sort column ascending">ユーザー名</th>
								<th class="sorting" tabindex="0" aria-controls="user-table" rowspan="1" colspan="1" 
									aria-label="種別: activate to sort column ascending">種別</th>
								<th class="sorting" tabindex="0" aria-controls="user-table" rowspan="1" colspan="1" 
									aria-label="途中退校日: activate to sort column ascending">途中退校日</th>
								<th class="sorting" tabindex="0" aria-controls="user-table" rowspan="1" colspan="1" 
									aria-label="コース名: activate to sort column ascending">コース名</th>
								<th class="sorting" tabindex="0" aria-controls="user-table" rowspan="1" colspan="1" 
									aria-label="企業名: activate to sort column ascending">企業名</th>
								<th class="sorting" tabindex="0" aria-controls="user-table" rowspan="1" colspan="1" 
									aria-label="会場: activate to sort column ascending">会場</th>
								<th class="sorting" tabindex="0" aria-controls="user-table" rowspan="1" colspan="1" 
									aria-label="詳細: activate to sort column ascending">詳細</th>
								<!-- Task.44 -->
								<th th:if="${session.loginUserDto.role == '0002'}" class="sorting" tabindex="0" aria-controls="user-table" rowspan="1" colspan="1" 
									aria-label="勤怠: activate to sort column ascending">勤怠</th>
								<!-- Task.79 -->
								<th:block th:if="${session.loginUserDto.role == '0004'}">
									<th class="sorting" tabindex="0" aria-controls="user-table" rowspan="1" colspan="1" 
										aria-label="編集: activate to sort column ascending">編集</th>
								</th:block>
							</tr>
						</thead>
						<tbody>
							<tr th:each="userDetailDto, stat : *{userDetailDtoList}" class="odd" role="row">
								<!-- Task.79 -->
								<td th:if="${session.loginUserDto.role == '0004'}">
									<input name="check" th:id="|checkbox[${stat.index}]|" class="icon-checkbox" type="checkbox" />
									<label th:for="|checkbox[${stat.index}]|" class="text-info">
										<span class="glyphicon glyphicon-unchecked unchecked"></span>
										<span class="glyphicon glyphicon-check checked"></span>
									</label>
									<input type="hidden" name="lmsUserId" th:value="${userDetailDto.lmsUserId}" />
									<input type="hidden" name="userName" th:value="${userDetailDto.userName}" />
									<input type="hidden" name="courseName" th:value="${userDetailDto.courseName}" />
									<input type="hidden" name="companyName" th:value="${userDetailDto.companyName}" />
									<input type="hidden" name="placeName" th:value="${userDetailDto.placeName}" />
									<input type="hidden" name="placeNote" th:value="${userDetailDto.placeNote}" />
								</td>

								<td class="sorting_1">[[${userDetailDto.userId}]]</td>
								<td>[[${userDetailDto.userName}]]</td>
								<td align="center">
									<!-- Task.79 -->
									<th:block th:each="role : *{roleEnum}">
										<span th:if="${role.code} == ${userDetailDto.role}">[[${role.value}]]</span>
									</th:block>
								</td>
								<td th:switch="${userDetailDto.leaveFlg}">
									<th:block th:case="1">[[${#dates.format(userDetailDto.leaveDate, "yyyy年M月d日")}]]</th:block>
									<th:block th:case="*">-</th:block>
								</td>
								<td>[[${userDetailDto.courseName}]]</td>
								<td>[[${userDetailDto.companyName}]]</td>
								<td>
									[[${userDetailDto.placeName}]]
									<th:block th:if="${!#strings.isEmpty(userDetailDto.placeNote)}">([[${userDetailDto.placeNote}]])</th:block>
									<br />[[${userDetailDto.placeDescription}]]
								</td>
								<td>
									<form method="post" th:action="@{/user/detail}">
										<input type="hidden" name="lmsUserId" th:value="${userDetailDto.lmsUserId}" />
										<input type="submit" value="詳細" class="btn btn-default" />
									</form>
								</td>
								<!-- Task.44 -->
								<td th:if="${session.loginUserDto.role == '0002'}">
									<form method="post" th:action="@{/attendance/list}" th:object="${attendanceSearchForm}">
										<input type="hidden" name="lmsUserId" th:value="${userDetailDto.lmsUserId}" />
										<input type="hidden" name="userName" th:value="${userDetailDto.userName}" />
										<input type="submit" value="勤怠確認" class="btn btn-default" />
									</form>
								</td>
								<!-- Task.79 -->
								<td th:if="${session.loginUserDto.role == '0004'}">
									<form th:action="@{/user/update}" method="post">
										<input type="hidden" name="lmsUserId" th:value="${userDetailDto.lmsUserId}" />
										<input type="submit" value="変更" class="btn btn-default" />
									</form>
									<form th:action="@{/user/delete}" method="post" onsubmit="return delcheck()">
										<input type="hidden" name="lmsUserId" th:value="${userDetailDto.lmsUserId}" />
										<input type="submit" value="削除" class="btn btn-default" />
									</form>
								</td>
							</tr>
						</tbody>
					</table>
					
				</div>
			</div>
		</div>
	
		<!-- Task.79 -->
		<form th:action="@{/user/bulkDelete}" method="post">
			<div class="modal fade" id="bulk-del-modal">
				<div class="modal-dialog modal-dialog-center">
					<div class="modal-content">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal">
								<span aria-hidden="true">&times;</span>
							</button>
							<h4 class="modal-title" id="modal-label">一括削除</h4>
						</div>
						<div class="modal-body"></div>
						<div class="modal-footer">
							<input type="submit" class="btn btn-primary" value="削除する" />
						</div>
					</div>
				</div>
			</div>
		</form>

	</th:block>
	
	<!-- Task.79 -->
	<script>
		$(function() {
			$('#bulk-delete').click(function() {
				var targetDiv = $($(this).attr('data-target') + ' .modal-dialog .modal-content');
				var chkRec = $('input[name=check]:checked').parents('tr');
				if (chkRec.length <= 0) {
					targetDiv.children('.modal-footer').hide();
					targetDiv.children('.modal-body').html('<span class="help-inline error">ユーザーを選択してください</span>');
				} else {
					targetDiv.children('.modal-footer').show();
					var html = '以下のユーザーが削除されます。';
					html = html + '<table class="table">';
					html = html + '<thead>';
					html = html + '<tr>';
					html = html + '<th>ユーザー</th>';
					html = html + '<th>コース</th>';
					html = html + '<th>企業</th>';
					html = html + '<th>会場</th>';
					html = html + '</tr>';
					html = html + '</thead>';
					html = html + '<tbody>';
					for (i = chkRec.length - 1; i >= 0; i--) {
						var lmsUserId = $(chkRec[i]).children('td').children(':hidden[name=lmsUserId]').val();
						var userName = $(chkRec[i]).children('td').children(':hidden[name=userName]').val();
						var courseName = $(chkRec[i]).children('td').children(':hidden[name=courseName]').val();
						courseName = courseName == '' ? '<small>(なし)</small>' : courseName;
						var companyName = $(chkRec[i]).children('td').children(':hidden[name=companyName]').val();
						companyName = companyName == '' ? '<small>(なし)</small>' : companyName;
						var placeName = $(chkRec[i]).children('td').children(':hidden[name=placeName]').val();
						placeName = placeName == '' ? '<small>(なし)</small>' : placeName;
						var placeNote = $(chkRec[i]).children('td').children(':hidden[name=placeNote]').val();
						placeName = placeNote == '' ? placeName : placeName + '<small>(' + placeNote + ')</small>';
						html = html + '<tr>';
						html = html + '<td>';
						html = html + userName;
						html = html + '<input type="hidden" name="lmsUserIdArr[' + i + ']" value="' + lmsUserId + '">';
						html = html + '</td>';
						html = html + '<td>' + courseName + '</td>';
						html = html + '<td>' + companyName + '</td>';
						html = html + '<td>' + placeName + '</td>';
						html = html + '</tr>';
					}
					html = html + '</tbody>';
					html = html + '</table>';
					targetDiv.children('.modal-body').html(html);
				}
			});

			$('#checkbox-all').click(function() {
				allCheck('#user-table', this);
			});
		});
	</script>
	
</body>
</html>